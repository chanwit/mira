include template: 'digitalocean'
apply plugin: "swarm"

REPO = "chanwit"
TAG  = "v1"

SERVICES = [rng, hasher, redis, webui, worker]

swarm {
  managers mg0
  workers  node1, node2, node3
}

task(provision) {
  docker machine create (DO_SGP_512MB, mg0)

  4.times {
    docker machine create (DO_SGP_512MB, "node${it}")
  }
}

task(build) {
  SERVICES.each {
    docker build (tag: "$REPO/$it:$TAG", it)
  }
}

task(up) {

  docker network create (driver: overlay, mynet)

  docker service create (
    name:    rng,
    network: [mynet],
    image:   "$REPO/rng:$TAG",
  )
  docker service create (
    name:    hasher,
    network: [mynet],
    image:   "$REPO/hasher:$TAG",
  )
  docker service create (
    name:    redis,
    network: [mynet],
    image:   redis,
  )
  docker service create (
    name:    webui,
    network: [mynet],
    image:   "$REPO/webui:$TAG",
    publish: [ 80:80 ],
  )
  docker service create (
    name:    worker,
    network: [mynet],
    image:   "$REPO/worker:$TAG",
  )

}

task(down) {
  SERVICES.each { docker service rm it }
  docker network rm mynet
}

task(clean) {
  docker machine rm node0, node1, node2, node3
  docker machine rm mg0
}

task(push) {
  (SERVICES - [redis]).each {
    docker push "$REPO/$it:$TAG"
  }
}